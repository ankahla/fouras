version: "3.9"

services:
    php:
        build:
            context: php
            target: symfony_php_dev
        restart: unless-stopped
        volumes:
            - php_socket:/var/run/php
            - ../:/var/www/app:rw

    caddy:
        image: caddy:2.7
        depends_on:
            - php
        environment:
            SERVER_NAME: ${SERVER_NAME:-localhost, caddy:80}
        restart: unless-stopped
        volumes:
            - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
            - ../public:/var/www/app/public:ro
            - php_socket:/var/run/php
            - caddy_data:/data
            - caddy_config:/config
        ports:
            # HTTP
            - target: 80
              published: 80
              protocol: tcp
            # HTTPS
            - target: 443
              published: 443
              protocol: tcp
            # HTTP/3
            - target: 443
              published: 443
              protocol: udp

    database:
        image: postgres:${POSTGRES_VERSION:-15}-alpine
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-fouras}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-!ChangeMe!}
            POSTGRES_USER: ${POSTGRES_USER:-app}
        volumes:
            - database_data:/var/lib/postgresql/data:rw

    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin4_container
        restart: always
        ports:
            - "8888:80"
        environment:
            PGADMIN_DEFAULT_EMAIL: user-name@domain-name.com
            PGADMIN_DEFAULT_PASSWORD: password
        volumes:
            - pgadmin_data:/var/lib/pgadmin

volumes:
    php_socket:
    caddy_data:
    caddy_config:
    database_data:
    pgadmin_data:
